"""
My Money GraphQL Schema
"""

scalar DateTime
scalar Decimal
scalar Upload
scalar JSON

enum SortOrder {
  asc
  desc
}

enum TransactionOrderBy {
  date
  value
  category
  account
  payee
}

enum CategoryType {
  Income
  Expense
}

enum AccountType {
  Cash
  CreditCard
  Bank
  Saving
  Loans
}

enum WorkspaceRole {
  Owner
  Admin
  Member
}

input TransactionOrderInput {
  field: TransactionOrderBy!
  direction: SortOrder!
}

type Query {
  """
  Get current user information
  """
  me: User!

  """
  Get all accounts for current user
  """
  accounts: [Account!]

  """
  Get account by ID
  """
  account(id: ID!): Account

  """
  Get account balance (calculated)
  """
  accountBalance(accountId: ID!): Decimal!

  """
  Get transactions with pagination

  **Pagination:**
  - Use `first` and `after` for cursor-based pagination (forward pagination)
  - Use `last` and `before` for backward pagination

  **Filtering:**
  - `accountId`: Filter by account
  - `categoryId`: Filter by category
  - `payeeId`: Filter by payee
  - `note`: Search in transaction notes (case-insensitive)

  **Performance:**
  - Maximum 100 transactions per page
  - Queries are cached for 5 minutes
  """
  transactions(
    accountId: ID
    categoryId: ID
    payeeId: ID
    first: Int
    after: String
    last: Int
    before: String
    orderBy: TransactionOrderInput
    note: String
  ): TransactionConnection!

  """
  Get last 30 transactions for home page
  """
  recentTransactions(limit: Int = 30, orderBy: TransactionOrderInput): [Transaction!]!

  """
  Get transaction by ID
  """
  transaction(id: ID!): Transaction

  """
  Get all categories
  """
  categories: [Category!]

  """
  Get category by ID
  """
  category(id: ID!): Category

  """
  Get all payees
  """
  payees: [Payee!]!

  """
  Get payee by ID
  """
  payee(id: ID!): Payee

  """
  Get user preferences
  """
  preferences: UserPreferences

  """
  Get recurring transactions
  """
  recurringTransactions: [RecurringTransaction!]!

  """
  Get report transactions with filters
  """
  reportTransactions(
    accountIds: [ID!]
    categoryIds: [ID!]
    payeeIds: [ID!]
    startDate: DateTime
    endDate: DateTime
    note: String
    orderBy: TransactionOrderInput
    skip: Int
    take: Int
    memberIds: [ID!]
  ): ReportTransactionConnection!

  """
  Get top 5 most used transaction values from recent transactions
  """
  topUsedValues(days: Int = 90): [TopUsedValue!]!

  """
  Get most commonly used account, payee, and category for a specific amount
  """
  mostUsedTransactionDetails(amount: Decimal!, days: Int = 90): MostUsedTransactionDetails

  """
  Export user data for CSV export
  Supports filtering by date range, accounts, categories, and payees
  """
  exportData(
    startDate: DateTime
    endDate: DateTime
    accountIds: [ID!]
    categoryIds: [ID!]
    payeeIds: [ID!]
    includeTransactions: Boolean = true
    includeRecurringTransactions: Boolean = true
    includeBudgets: Boolean = true
    memberIds: [ID!]
  ): ExportData!

  """
  Get all budgets for current user
  """
  budgets: [Budget!]!

  """
  Get budget by ID
  """
  budget(id: ID!): Budget

  """
  Get budget notifications for current user
  """
  budgetNotifications: [BudgetNotification!]!

  """
  Get all workspaces the current user belongs to
  """
  workspaces: [Workspace!]!

  """
  Get workspace by ID
  """
  workspace(id: ID!): Workspace

  """
  Get workspace members
  """
  workspaceMembers(workspaceId: ID!): [WorkspaceMember!]!

  """
  Get workspace invitations
  """
  workspaceInvitations(workspaceId: ID!): [WorkspaceInvitation!]!

  """
  Get invitation by token (public, for viewing invitation details)
  """
  invitationByToken(token: String!): WorkspaceInvitation

  """
  Get unresolved conflicts for a workspace
  """
  entityConflicts(workspaceId: ID!): [EntityConflict!]!

  """
  Get conflict by ID
  """
  entityConflict(id: ID!): EntityConflict

  """
  Get version history for an entity
  """
  entityVersions(entityType: String!, entityId: ID!, limit: Int = 50): [EntityVersion!]!
}

type Mutation {
  """
  Create a new account
  """
  createAccount(input: CreateAccountInput!): Account!

  """
  Update account
  """
  updateAccount(id: ID!, input: UpdateAccountInput!): Account!

  """
  Delete account (cannot delete default account)
  """
  deleteAccount(id: ID!): Boolean!

  """
  Create a transaction
  """
  createTransaction(input: CreateTransactionInput!): Transaction!

  """
  Update transaction
  """
  updateTransaction(id: ID!, input: UpdateTransactionInput!): Transaction!

  """
  Delete transaction
  """
  deleteTransaction(id: ID!): Boolean!

  """
  Create category
  """
  createCategory(input: CreateCategoryInput!): Category!

  """
  Update category
  """
  updateCategory(id: ID!, input: UpdateCategoryInput!): Category!

  """
  Delete category
  """
  deleteCategory(id: ID!): Boolean!

  """
  Create payee
  """
  createPayee(input: CreatePayeeInput!): Payee!

  """
  Update payee
  """
  updatePayee(id: ID!, input: UpdatePayeeInput!): Payee!

  """
  Delete payee
  """
  deletePayee(id: ID!): Boolean!

  """
  Update user preferences
  """
  updatePreferences(input: UpdatePreferencesInput!): UserPreferences!

  """
  Create recurring transaction
  """
  createRecurringTransaction(input: CreateRecurringTransactionInput!): RecurringTransaction!

  """
  Update recurring transaction
  """
  updateRecurringTransaction(id: ID!, input: UpdateRecurringTransactionInput!): RecurringTransaction!

  """
  Delete recurring transaction
  """
  deleteRecurringTransaction(id: ID!): Boolean!

  """
  Upload PDF for import
  """
  uploadPDF(file: Upload!, dateFormat: String): PDFUploadResult!

  """
  Match imported transaction
  """
  matchImportedTransaction(importedId: ID!, transactionId: ID!): ImportedTransaction!

  """
  Save imported transactions with manual mappings
  """
  saveImportedTransactions(mapping: BulkMappingInput!): SaveImportedTransactionsResult!

  """
  Delete all unmapped imported transactions
  """
  deleteUnmappedImportedTransactions: Boolean!

  """
  Import CSV file and merge data
  """
  importCSV(file: Upload!, entityType: String!): ImportResult!

  """
  Reset all user data except default account, category, and payee
  """
  resetData: Boolean!

  """
  Add example data to database (accounts, categories, payees)
  """
  addExampleData: Boolean!

  """
  Create a new budget
  """
  createBudget(input: CreateBudgetInput!): Budget!

  """
  Update budget
  """
  updateBudget(id: ID!, input: UpdateBudgetInput!): Budget!

  """
  Delete budget
  """
  deleteBudget(id: ID!): Boolean!

  """
  Mark budget notification as read
  """
  markBudgetNotificationRead(id: ID!): Boolean!

  """
  Create a new workspace
  """
  createWorkspace(input: CreateWorkspaceInput!): Workspace!

  """
  Update workspace
  """
  updateWorkspace(id: ID!, input: UpdateWorkspaceInput!): Workspace!

  """
  Delete workspace (Owner only)
  """
  deleteWorkspace(id: ID!): Boolean!

  """
  Invite user to workspace
  """
  inviteUserToWorkspace(workspaceId: ID!, email: String!, role: WorkspaceRole): WorkspaceInvitation!

  """
  Accept workspace invitation
  """
  acceptWorkspaceInvitation(token: String!): WorkspaceMember!

  """
  Cancel workspace invitation
  """
  cancelWorkspaceInvitation(invitationId: ID!): Boolean!

  """
  Update workspace member role
  """
  updateWorkspaceMemberRole(workspaceId: ID!, memberId: ID!, role: WorkspaceRole!): WorkspaceMember!

  """
  Remove workspace member
  """
  removeWorkspaceMember(workspaceId: ID!, memberId: ID!): Boolean!

  """
  Resolve a conflict by choosing a version
  """
  resolveConflict(conflictId: ID!, chosenVersion: Int!, mergeData: JSON): EntityConflict!

  """
  Dismiss a conflict (use current version)
  """
  dismissConflict(conflictId: ID!): Boolean!

  """
  Bulk create accounts
  Creates multiple accounts in a single transaction
  """
  bulkCreateAccounts(inputs: [BatchCreateAccountInput!]!): BatchAccountResult!

  """
  Bulk update accounts
  Updates multiple accounts in a single transaction
  """
  bulkUpdateAccounts(inputs: [BatchUpdateAccountInput!]!): BatchAccountResult!

  """
  Bulk create categories
  Creates multiple categories in a single transaction
  """
  bulkCreateCategories(inputs: [BatchCreateCategoryInput!]!): BatchCategoryResult!

  """
  Bulk update categories
  Updates multiple categories in a single transaction
  """
  bulkUpdateCategories(inputs: [BatchUpdateCategoryInput!]!): BatchCategoryResult!

  """
  Bulk create payees
  Creates multiple payees in a single transaction
  """
  bulkCreatePayees(inputs: [BatchCreatePayeeInput!]!): BatchPayeeResult!

  """
  Bulk update payees
  Updates multiple payees in a single transaction
  """
  bulkUpdatePayees(inputs: [BatchUpdatePayeeInput!]!): BatchPayeeResult!

  """
  Bulk create transactions
  Creates multiple transactions in a single transaction
  """
  bulkCreateTransactions(inputs: [BatchCreateTransactionInput!]!): BatchTransactionResult!

  """
  Bulk update transactions
  Updates multiple transactions in a single transaction
  """
  bulkUpdateTransactions(inputs: [BatchUpdateTransactionInput!]!): BatchTransactionResult!
}

type Subscription {
  """
  Subscribe to account updates
  Filters by workspaceId to only receive updates for accounts in the current workspace
  """
  accountUpdated(workspaceId: ID!): Account!

  """
  Subscribe to category updates
  Filters by workspaceId to only receive updates for categories in the current workspace
  """
  categoryUpdated(workspaceId: ID!): Category!

  """
  Subscribe to payee updates
  Filters by workspaceId to only receive updates for payees in the current workspace
  """
  payeeUpdated(workspaceId: ID!): Payee!

  """
  Subscribe to transaction updates
  Filters by workspaceId to only receive updates for transactions in the current workspace
  """
  transactionUpdated(workspaceId: ID!): Transaction!

  """
  Subscribe to budget updates
  Filters by workspaceId to only receive updates for budgets in the current workspace
  """
  budgetUpdated(workspaceId: ID!): Budget!

  """
  Subscribe to entity conflict notifications
  Filters by workspaceId to only receive conflict notifications for the current workspace
  """
  entityConflictDetected(workspaceId: ID!): EntityConflict!
}

type User {
  id: ID!
  oidcSubject: String!
  email: String!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type Account {
  id: ID!
  name: String!
  initBalance: Decimal!
  isDefault: Boolean!
  accountType: AccountType!
  workspaceId: ID!
  version: Int!
  createdBy: User!
  lastEditedBy: User!
  versions: [EntityVersion!]!
  createdAt: DateTime!
  updatedAt: DateTime!
  balance: Decimal!
}

type Transaction {
  id: ID!
  value: Decimal!
  date: DateTime!
  accountId: ID!
  account: Account
  categoryId: ID
  category: Category
  payeeId: ID
  payee: Payee
  note: String
  version: Int!
  createdBy: User!
  lastEditedBy: User!
  versions: [EntityVersion!]!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type TransactionConnection {
  items: [Transaction!]!
  totalCount: Int!
  hasMore: Boolean!
  nextCursor: String
}

type Category {
  id: ID!
  name: String!
  categoryType: CategoryType!
  isDefault: Boolean!
  workspaceId: ID!
  version: Int!
  createdBy: User!
  lastEditedBy: User!
  versions: [EntityVersion!]!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type Payee {
  id: ID!
  name: String!
  isDefault: Boolean!
  workspaceId: ID!
  version: Int!
  createdBy: User!
  lastEditedBy: User!
  versions: [EntityVersion!]!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type UserPreferences {
  id: ID!
  userId: ID!
  currency: String!
  useThousandSeparator: Boolean!
  colorScheme: String
  colorSchemeValue: String
  dateFormat: String
  createdAt: DateTime!
  updatedAt: DateTime!
}

type RecurringTransaction {
  id: ID!
  cronExpression: String!
  value: Decimal!
  accountId: ID!
  account: Account
  categoryId: ID
  category: Category
  payeeId: ID
  payee: Payee
  note: String
  nextRunDate: DateTime!
  userId: ID!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type ImportedTransaction {
  id: ID!
  rawDate: String!
  rawDescription: String!
  rawDebit: Decimal
  rawCredit: Decimal
  matched: Boolean!
  transactionId: ID
  transaction: Transaction
  userId: ID!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type PDFUploadResult {
  success: Boolean!
  importedCount: Int!
  savedCount: Int!
  unmappedTransactions: [UnmappedTransaction!]!
}

type UnmappedTransaction {
  id: ID!
  rawDate: String!
  rawDescription: String!
  rawDebit: Decimal
  rawCredit: Decimal
  suggestedAccountId: ID
  suggestedCategoryId: ID
  suggestedPayeeId: ID
  cardNumber: String
  detectedWorkspaceId: ID
}

type ReportTransactionConnection {
  items: [Transaction!]!
  totalCount: Int!
  totalAmount: Decimal!
  totalIncome: Decimal!
  totalExpense: Decimal!
}

type TopUsedValue {
  value: String!
  count: Int!
}

type MostUsedTransactionDetails {
  accountId: ID
  payeeId: ID
  categoryId: ID
  count: Int!
}

type ExportData {
  accounts: [Account!]!
  categories: [Category!]!
  payees: [Payee!]!
  transactions: [Transaction!]!
  recurringTransactions: [RecurringTransaction!]!
  preferences: UserPreferences
  budgets: [Budget!]!
  importMatchRules: [ImportMatchRule!]!
}

type Budget {
  id: ID!
  workspaceId: ID!
  amount: Decimal!
  currentSpent: Decimal!
  accountId: ID
  categoryId: ID
  payeeId: ID
  account: Account
  category: Category
  payee: Payee
  version: Int!
  createdBy: User!
  lastEditedBy: User!
  versions: [EntityVersion!]!
  percentageUsed: Float!
  lastResetDate: DateTime!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type BudgetNotification {
  id: ID!
  userId: ID!
  budgetId: ID!
  budget: Budget
  threshold: Float!
  message: String!
  read: Boolean!
  createdAt: DateTime!
}

type ImportMatchRule {
  id: ID!
  pattern: String!
  accountId: ID
  categoryId: ID
  payeeId: ID
  userId: ID!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type ImportResult {
  success: Boolean!
  created: Int!
  updated: Int!
  errors: [String!]!
}

input CreateAccountInput {
  name: String!
  initBalance: Decimal
  accountType: AccountType
  workspaceId: ID
}

input UpdateAccountInput {
  name: String
  initBalance: Decimal
  accountType: AccountType
  expectedVersion: Int
}

input CreateTransactionInput {
  value: Decimal!
  date: DateTime
  accountId: ID!
  categoryId: ID
  payeeId: ID
  note: String
}

input UpdateTransactionInput {
  value: Decimal
  date: DateTime
  accountId: ID
  categoryId: ID
  payeeId: ID
  note: String
  expectedVersion: Int
}

input CreateCategoryInput {
  name: String!
  categoryType: CategoryType!
  workspaceId: ID
}

input UpdateCategoryInput {
  name: String
  categoryType: CategoryType
  expectedVersion: Int
}

input CreatePayeeInput {
  name: String!
  workspaceId: ID
}

input UpdatePayeeInput {
  name: String
  expectedVersion: Int
}

input UpdatePreferencesInput {
  currency: String
  useThousandSeparator: Boolean
  colorScheme: String
  colorSchemeValue: String
  dateFormat: String
}

input CreateRecurringTransactionInput {
  cronExpression: String!
  value: Decimal!
  accountId: ID!
  categoryId: ID
  payeeId: ID
  note: String
  nextRunDate: DateTime!
}

input UpdateRecurringTransactionInput {
  cronExpression: String
  value: Decimal
  accountId: ID
  categoryId: ID
  payeeId: ID
  note: String
  nextRunDate: DateTime
}

input SaveImportedTransactionInput {
  rawDate: String!
  rawDescription: String!
  value: Decimal!
  date: DateTime!
  accountId: ID!
  categoryId: ID
  payeeId: ID
  note: String
}

input DescriptionMappingInput {
  description: String!
  accountId: ID!
  categoryId: ID
  payeeId: ID
}

input BulkMappingInput {
  cardNumber: String
  cardAccountId: ID
  descriptionMappings: [DescriptionMappingInput!]!
}

type SaveImportedTransactionsResult {
  success: Boolean!
  savedCount: Int!
  errors: [String!]!
}

input CreateBudgetInput {
  amount: Decimal!
  accountId: ID
  categoryId: ID
  payeeId: ID
  workspaceId: ID
}

input UpdateBudgetInput {
  amount: Decimal
  expectedVersion: Int
}

input CreateWorkspaceInput {
  name: String!
}

input UpdateWorkspaceInput {
  name: String
}

"""
Batch operation input types
"""
input BatchCreateAccountInput {
  name: String!
  initBalance: Decimal
  accountType: AccountType
  workspaceId: ID
}

input BatchUpdateAccountInput {
  id: ID!
  name: String
  initBalance: Decimal
  accountType: AccountType
}

input BatchCreateCategoryInput {
  name: String!
  categoryType: CategoryType!
  workspaceId: ID
}

input BatchUpdateCategoryInput {
  id: ID!
  name: String
  categoryType: CategoryType
}

input BatchCreatePayeeInput {
  name: String!
  workspaceId: ID
}

input BatchUpdatePayeeInput {
  id: ID!
  name: String
}

input BatchCreateTransactionInput {
  value: Decimal!
  date: DateTime
  accountId: ID!
  categoryId: ID
  payeeId: ID
  note: String
}

input BatchUpdateTransactionInput {
  id: ID!
  value: Decimal
  date: DateTime
  accountId: ID
  categoryId: ID
  payeeId: ID
  note: String
}

"""
Batch operation result types
"""
type BatchAccountResult {
  created: [Account!]!
  updated: [Account!]!
  errors: [BatchError!]!
}

type BatchCategoryResult {
  created: [Category!]!
  updated: [Category!]!
  errors: [BatchError!]!
}

type BatchPayeeResult {
  created: [Payee!]!
  updated: [Payee!]!
  errors: [BatchError!]!
}

type BatchTransactionResult {
  created: [Transaction!]!
  updated: [Transaction!]!
  errors: [BatchError!]!
}

type BatchError {
  index: Int!
  message: String!
}

type Workspace {
  id: ID!
  name: String!
  createdAt: DateTime!
  updatedAt: DateTime!
  members: [WorkspaceMember!]!
  invitations: [WorkspaceInvitation!]!
  _count: WorkspaceCount
}

type WorkspaceCount {
  members: Int!
  accounts: Int!
}

type WorkspaceMember {
  id: ID!
  workspaceId: ID!
  userId: ID!
  role: WorkspaceRole!
  joinedAt: DateTime!
  workspace: Workspace!
  user: User!
}

type WorkspaceInvitation {
  id: ID!
  workspaceId: ID!
  email: String!
  token: String!
  role: WorkspaceRole!
  invitedBy: ID!
  expiresAt: DateTime!
  acceptedAt: DateTime
  createdAt: DateTime!
  workspace: Workspace!
  inviter: User!
}

type EntityVersion {
  id: ID!
  entityType: String!
  entityId: ID!
  version: Int!
  data: JSON!
  editedBy: ID!
  editedAt: DateTime!
  editor: User!
}

type EntityConflict {
  id: ID!
  entityType: String!
  entityId: ID!
  currentVersion: Int!
  incomingVersion: Int!
  currentData: JSON!
  incomingData: JSON!
  workspaceId: ID!
  detectedAt: DateTime!
  resolvedAt: DateTime
  resolvedBy: ID
  resolvedVersion: Int
  resolver: User
}



