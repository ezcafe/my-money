# Docker Compose configuration for My Money Application
# Note: version field is obsolete in Docker Compose v2+

services:
  # PostgreSQL database service
  # Uncomment and configure for local development
  # For production, use managed database service (RDS, Cloud SQL, etc.)
  postgres:
    image: postgres:18-alpine
    container_name: my-money-postgres
    env_file:
      - ../.env
    environment:
      # Require explicit POSTGRES_USER and POSTGRES_PASSWORD in production
      # For development, set these in .env file
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-mymoney}
      # Disable unnecessary extensions for security
      POSTGRES_INITDB_ARGS: "-A trust"
    # PostgreSQL 18 Asynchronous I/O (AIO) configuration
    # AIO improves I/O performance for sequential scans, bitmap heap scans, and maintenance tasks
    command: >
      postgres
      -c io_method=worker
      -c io_workers=3
      -c effective_io_concurrency=16
      -c maintenance_io_concurrency=16
      -c io_max_concurrency=-1
      -c io_combine_limit=128kB
      -c io_max_combine_limit=128kB
    # Database port exposed for local development only
    # Remove in production or use conditional port mapping
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - my-money-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
      platforms:
        - linux/amd64
        - linux/arm64
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')}
        VERSION: ${VERSION:-1.0.0}
        NODE_VERSION: ${NODE_VERSION:-25.2.1}
    container_name: my-money-backend
    env_file:
      - ../.env
    environment:
      # Database connection - adjust host if using external database
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-mymoney}}
      PORT: 4000
      NODE_ENV: production
      # OIDC variables are loaded from env_file (.env) above
      # No need to set them explicitly here - env_file will load them into the container
    ports:
      - "4000:4000"
    # Uncomment when using local postgres service
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    networks:
      - my-money-network
    healthcheck:
      # Enhanced health check using Node.js HTTP client with timeout
      # Checks health endpoint and validates JSON response
      # Accepts both 'ok' and 'degraded' status as healthy
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/health', {timeout: 5000}, (r) => {let d='';r.on('data',c=>d+=c);r.on('end',()=>{try{const j=JSON.parse(d);const healthy=j.status==='ok'||j.status==='degraded';process.exit(healthy?0:1)}catch{process.exit(r.statusCode===200?0:1)}})}).on('error',()=>process.exit(1)).on('timeout',()=>process.exit(1))"]
      interval: 20s
      timeout: 8s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    # Read-only root filesystem for maximum security
    # Write access is provided via tmpfs mounts for required directories
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /var/tmp:noexec,nosuid,size=50m
      # Prisma may need cache directory (optional, but safer to provide)
      - /app/backend/.prisma:noexec,nosuid,size=10m

  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
      platforms:
        - linux/amd64
        - linux/arm64
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')}
        VERSION: ${VERSION:-1.0.0}
        NODE_VERSION: ${NODE_VERSION:-25.2.1}
        NGINX_VERSION: ${NGINX_VERSION:-alpine}
    container_name: my-money-frontend
    ports:
      - "3000:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - my-money-network
    healthcheck:
      # Enhanced health check for frontend nginx
      # Tests both nginx configuration and HTTP endpoint availability
      test: ["CMD-SHELL", "nginx -t && wget --no-verbose --tries=1 --spider --timeout=5 http://127.0.0.1/health 2>/dev/null || exit 1"]
      interval: 20s
      timeout: 8s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    # Read-only root filesystem for maximum security
    # Nginx runtime files are provided via tmpfs mounts
    read_only: true
    tmpfs:
      - /var/cache/nginx:noexec,nosuid,size=50m
      - /var/log/nginx:noexec,nosuid,size=20m
      - /var/run:noexec,nosuid,size=10m
      - /tmp:noexec,nosuid,size=50m

volumes:
  postgres_data:
    driver: local

networks:
  my-money-network:
    driver: bridge


